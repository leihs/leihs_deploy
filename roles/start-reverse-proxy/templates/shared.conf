# Managed with ansible

LimitRequestFields 500
LimitRequestFieldSize 32768


AllowEncodedSlashes NoDecode
ProxyRequests off
RewriteEngine on


AllowEncodedSlashes NoDecode

DocumentRoot /leihs/legacy/public
<Directory /leihs/legacy/public >
  Require all granted
</Directory>




{% if reverse_proxy_custom_config is defined %}

###############################################################################
### Custom Config #############################################################
###############################################################################

{{reverse_proxy_custom_config}}

{% endif %}




{% if shibboleth_sign_in_enabled %}

###############################################################################
### Shibboleth ################################################################
###############################################################################

# https://test-blank.leihs.zhdk.ch/Shibboleth.sso/Login?target=https%3A%2F%2Ftest-blank.leihs.zhdk.ch%2FShibboleth.sso%2FSession

ProxyPass /Shibboleth.sso/Login !
ProxyPass /Shibboleth.sso/SAML2/POST !
ProxyPass /Shibboleth.sso/Metadata !

RewriteRule /Shibboleth.sso/Session /auth/shib-sign-in  [END,R=permanent]

<IfModule mod_shib>
  <Location /Shibboleth.sso>
    SetHandler shib
    ShibUseHeaders On
  </Location>
</IfModule>

<Location /Shibboleth.sso/Session>
  AuthType shibboleth
  Require shibboleth
  ShibRequestSetting requireSession 1
  #Require valid-user
  ShibUseHeaders On
</Location>

<Location /auth/shib-sign-in>
  AuthType shibboleth
  Require shibboleth
  ShibRequestSetting requireSession 1
  # Require valid-user
  ShibUseHeaders On
</Location>

{% else %}

RewriteRule "/session/shib-sign-in" "-" [L,F]

{% endif %}



###############################################################################
### Legacy Assets #############################################################
###############################################################################
#
ProxyPass /assets !

Alias /assets /leihs/legacy/public/assets
<Directory /leihs/legacy/public/assets>
    Require all granted
</Directory>

<LocationMatch "^/assets/.*$">
    Header unset ETag
    FileETag None
    # RFC says only cache for 1 year
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
</LocationMatch>



###############################################################################
### Reverse proxy #############################################################
###############################################################################

Define leihs_legacy_port {{leihs_legacy_port}}
Define leihs_admin_port {{leihs_admin_port}}
Define leihs_procure_port {{leihs_procure_port}}
Define leihs_procure_client_port  {{leihs_procure_client_port}}
Define leihs_my_port {{leihs_my_port}}


RewriteRule ^/admin/users$ /admin/users/ [R]
#RewriteRule ^/logout$ /auth/sign-out

## my
ProxyPassMatch "^/$"  				  http://localhost:${leihs_my_port} 									    nocanon retry=0
ProxyPass /my        					  http://localhost:${leihs_my_port}/my 		          		  nocanon retry=0
ProxyPass /user       					 http://localhost:${leihs_my_port}/user            		  nocanon retry=0
ProxyPass /sign-in   					  http://localhost:${leihs_my_port}/sign-in                nocanon retry=0
ProxyPass /sign-out  					  http://localhost:${leihs_my_port}/sign-out               nocanon retry=0

## legacy admin
ProxyPass /admin/audits          http://localhost:${leihs_legacy_port}/admin/audits            nocanon retry=0
ProxyPass /admin/buildings       http://localhost:${leihs_legacy_port}/admin/buildings         nocanon retry=0
ProxyPass /admin/fields_editor   http://localhost:${leihs_legacy_port}/admin/fields_editor     nocanon retry=0
ProxyPass /admin/inventory_pools http://localhost:${leihs_legacy_port}/admin/inventory_pools   nocanon retry=0
ProxyPass /admin/languages       http://localhost:${leihs_legacy_port}/admin/languages         nocanon retry=0
ProxyPass /admin/mail_templates  http://localhost:${leihs_legacy_port}/admin/mail_templates    nocanon retry=0
ProxyPass /admin/rooms           http://localhost:${leihs_legacy_port}/admin/rooms             nocanon retry=0
ProxyPass /admin/settings        http://localhost:${leihs_legacy_port}/admin/settings          nocanon retry=0
ProxyPass /admin/statistics      http://localhost:${leihs_legacy_port}/admin/statistics        nocanon retry=0
ProxyPass /admin/suppliers       http://localhost:${leihs_legacy_port}/admin/suppliers         nocanon retry=0
# Note: Users UI is in new admin, but the search backend from old admin is still needed
ProxyPass /admin/users.json      http://localhost:${leihs_legacy_port}/admin/users.json        nocanon retry=0


## admin & API
ProxyPass /admin    					  http://localhost:${leihs_admin_port}/admin               nocanon retry=0 keepalive=On timeout=180

# procure2
ProxyPass /procure/attachments	http://localhost:${leihs_procure_port}/procure/attachments		nocanon retry=0
ProxyPass /procure/graphql			http://localhost:${leihs_procure_port}/procure/graphql		nocanon retry=0
ProxyPass /procure/images			  http://localhost:${leihs_procure_port}/procure/images		nocanon retry=0
ProxyPass /procure/upload			  http://localhost:${leihs_procure_port}/procure/upload		nocanon retry=0
ProxyPass /procure			        http://localhost:${leihs_procure_client_port}/procure						nocanon retry=0

## everything else goes to legacy
ProxyPass /       http://localhost:${leihs_legacy_port}/       nocanon retry=0

# vim: syntax=apache
